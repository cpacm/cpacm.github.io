<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Android开发日记（十四）——带你解决 WebView 里的常见问题 | cpacm</title><meta name="description" content="Android开发日记（十四）——带你解决 WebView 里的常见问题"><meta name="keywords" content="Android,开发系列"><meta name="author" content="cpacm,348515494@qq.com"><meta name="copyright" content="cpacm"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://www.cpacm.net/2017/02/10/Android开发日记（十四）——带你解决 WebView 里的常见问题/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Android开发日记（十四）——带你解决 WebView 里的常见问题"><meta name="twitter:description" content="Android开发日记（十四）——带你解决 WebView 里的常见问题"><meta name="twitter:image" content="http://www.cpacm.net/img/android.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Android开发日记（十四）——带你解决 WebView 里的常见问题"><meta property="og:url" content="http://www.cpacm.net/2017/02/10/Android开发日记（十四）——带你解决 WebView 里的常见问题/"><meta property="og:site_name" content="cpacm"><meta property="og:description" content="Android开发日记（十四）——带你解决 WebView 里的常见问题"><meta property="og:image" content="http://www.cpacm.net/img/android.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Android开发日记（十五）—— 音乐播放器要点" href="http://www.cpacm.net/2017/02/19/Android开发日记（十五）——音乐播放器要点/"><link rel="next" title="MySQL基础知识" href="http://www.cpacm.net/2017/02/10/MySQL基础知识/"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-143443034-1', 'auto');
ga('send', 'pageview');
</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"http://cpacm.net/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用了-WebView-还是跳转到了系统自带的浏览器？"><span class="toc-number">1.</span> <span class="toc-text">使用了 WebView 还是跳转到了系统自带的浏览器？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取网页的标题和图标"><span class="toc-number">2.</span> <span class="toc-text">获取网页的标题和图标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#返回键实现网页的后退键"><span class="toc-number">3.</span> <span class="toc-text">返回键实现网页的后退键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置-WebView-的-header"><span class="toc-number">4.</span> <span class="toc-text">设置 WebView 的 header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置-WebView-的-User-Agent"><span class="toc-number">5.</span> <span class="toc-text">设置 WebView 的 User-Agent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何设置-WebView-的缓存"><span class="toc-number">6.</span> <span class="toc-text">如何设置 WebView 的缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#无法下载文件？"><span class="toc-number">7.</span> <span class="toc-text">无法下载文件？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#无法打开文件选择器？"><span class="toc-number">8.</span> <span class="toc-text">无法打开文件选择器？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么为-WebView-的加载添加进度条"><span class="toc-number">9.</span> <span class="toc-text">怎么为 WebView 的加载添加进度条</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎样对页面进行-Js-注入？"><span class="toc-number">10.</span> <span class="toc-text">怎样对页面进行 Js 注入？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何手动添加-Cookie"><span class="toc-number">11.</span> <span class="toc-text">如何手动添加 Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何使-HTML5-video-在-WebView-全屏显示"><span class="toc-number">12.</span> <span class="toc-text">如何使 HTML5 video 在 WebView 全屏显示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Android5-0上-WebView中Http和Https混合问题"><span class="toc-number">13.</span> <span class="toc-text">Android5.0上 WebView中Http和Https混合问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何避免-WebView-的内存泄露问题"><span class="toc-number">14.</span> <span class="toc-text">如何避免 WebView 的内存泄露问题</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number"></span> <span class="toc-text">总结</span></a></li></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/android.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">cpacm</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="/img/author.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">请不要忘记，那给你带来感动的，名为二次元的理想乡。</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Android开发日记（十四）——带你解决 WebView 里的常见问题</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2017-02-10<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-07-10</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.5k</span><span class="post-meta__separator">|</span><span>阅读时长: 11 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>通常我们在自己开发的 APP 中打开网页无非两种方法： 一是跳转到系统自带的浏览器，二是使用 WebView 控件加载页面。使用 WebView 控件的好处就是可以通过各种 api 接口来定制各种行为，常用的几个设置地方为 <strong>WebSettings</strong>、<strong>JavaScriptInterface</strong>、<strong>WebViewClient</strong> 和 <strong>WebChromeClient</strong>。平时出现的问题都可以通过修改这些设置来解决。<br><a id="more"></a></p>
<h3 id="使用了-WebView-还是跳转到了系统自带的浏览器？"><a href="#使用了-WebView-还是跳转到了系统自带的浏览器？" class="headerlink" title="使用了 WebView 还是跳转到了系统自带的浏览器？"></a>使用了 WebView 还是跳转到了系统自带的浏览器？</h3><p>很简单的解决方法，为你的 webview 设置一个新的 WebViewClient。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> WebViewClient()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> </span>&#123;</span><br><span class="line">        view.loadUrl(url);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 或者直接添加，效果是一样的</span></span><br><span class="line">webView.setWebViewClient(<span class="keyword">new</span> WebViewClient());</span><br></pre></td></tr></table></figure>
<h3 id="获取网页的标题和图标"><a href="#获取网页的标题和图标" class="headerlink" title="获取网页的标题和图标"></a>获取网页的标题和图标</h3><p>通过 WebChromeClient 可以获取到这些信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebChromeClient(<span class="keyword">new</span> WebChromeClient() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceivedTitle</span><span class="params">(WebView view, String title)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onReceivedTitle(view, title);</span><br><span class="line">        setTitle(title);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceivedIcon</span><span class="params">(WebView view, Bitmap icon)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onReceivedIcon(view, icon);</span><br><span class="line">        setIcon(icon);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>但是，这里有个问题，当通过 <code>webView.goBack()</code> 方式返回上一级Web页面的时候不会触发这个方法，因此会导致标题无法跟随历史记录返回上一级页面。所以需要在 <code>onPageFinished()</code> 中对界面标题重新设置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> WebViewClient()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageFinished</span><span class="params">(WebView view, String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPageFinished(view, url);</span><br><span class="line">        setTitle(String.valueOf(view.getTitle()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="返回键实现网页的后退键"><a href="#返回键实现网页的后退键" class="headerlink" title="返回键实现网页的后退键"></a>返回键实现网页的后退键</h3><p>在 WebView 中可以通过 goBack() 方法后退到历史记录的上一项。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 Actvity 中监听返回键按钮</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (webView.canGoBack())</span><br><span class="line">        webView.goBack();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">super</span>.onBackPressed();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="设置-WebView-的-header"><a href="#设置-WebView-的-header" class="headerlink" title="设置 WebView 的 header"></a>设置 WebView 的 header</h3><p>在 WebView 的 <code>loadUrl()</code> 方法中传入 Header 参数即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadURLWithHTTPHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String url = <span class="string">"http://cpacm.net"</span>;</span><br><span class="line">    WebView webView = <span class="keyword">new</span> WebView(getActivity());</span><br><span class="line">    Map&lt;String,String&gt; extraHeaders = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    extraHeaders.put(<span class="string">"Referer"</span>, <span class="string">"http://www.google.com"</span>);</span><br><span class="line">    webView.loadUrl(url, extraHeaders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="设置-WebView-的-User-Agent"><a href="#设置-WebView-的-User-Agent" class="headerlink" title="设置 WebView 的 User-Agent"></a>设置 WebView 的 User-Agent</h3><p>不要试图在 Header 里面去修改，而是在 WebSettings 修改<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.getSettings().setUserAgentString(<span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:50.0) Gecko/20100101 Firefox/50.0"</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="如何设置-WebView-的缓存"><a href="#如何设置-WebView-的缓存" class="headerlink" title="如何设置 WebView 的缓存"></a>如何设置 WebView 的缓存</h3><p>当需要本地缓存网页的时候就需要打开 WebViewSettings 的缓存开关,这样子当下次进到该页面无网络的情况下也能打开页面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">WebSettings settings = webView.getSettings();</span><br><span class="line">settings.setAppCacheEnabled(<span class="keyword">true</span>); <span class="comment">//启用应用缓存</span></span><br><span class="line">settings.setDomStorageEnabled(<span class="keyword">true</span>); <span class="comment">//启用或禁用DOM缓存。</span></span><br><span class="line">settings.setDatabaseEnabled(<span class="keyword">true</span>); <span class="comment">//启用或禁用DOM缓存。</span></span><br><span class="line"><span class="keyword">if</span> (SystemUtil.isNetworkConnected()) &#123; <span class="comment">//判断是否联网</span></span><br><span class="line">    settings.setCacheMode(WebSettings.LOAD_DEFAULT); <span class="comment">//默认的缓存使用模式</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    settings.setCacheMode(WebSettings.LOAD_CACHE_ONLY); <span class="comment">//不从网络加载数据，只从缓存加载数据。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="无法下载文件？"><a href="#无法下载文件？" class="headerlink" title="无法下载文件？"></a>无法下载文件？</h3><p>在自己写的 WebView 下是无法直接下载文件，需要自己监听下载事件并对下载的动作进行处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 当下载文件时打开系统自带的浏览器进行下载，当然也可以对捕获到的 url 进行处理在应用内下载。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">webView.setDownloadListener(<span class="keyword">new</span> FileDownLoadListener());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDownLoadListener</span> <span class="keyword">implements</span> <span class="title">DownloadListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDownloadStart</span><span class="params">(String url, String userAgent, String contentDisposition, String mimetype, <span class="keyword">long</span> contentLength)</span> </span>&#123;</span><br><span class="line">        Uri uri = Uri.parse(url);</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW, uri);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="无法打开文件选择器？"><a href="#无法打开文件选择器？" class="headerlink" title="无法打开文件选择器？"></a>无法打开文件选择器？</h3><p>通过重写 <code>WebChromeClient</code> 来实现点击 <code>&lt;input type=&#39;file&#39;&gt;</code> 来打开系统文件选择器。</p>
<p><strong>一个完整的Activity示例</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Android 5.0以下版本的文件选择回调 */</span></span><br><span class="line">    <span class="keyword">protected</span> ValueCallback&lt;Uri&gt; mFileUploadCallbackFirst;</span><br><span class="line">    <span class="comment">/** Android 5.0及以上版本的文件选择回调 */</span></span><br><span class="line">    <span class="keyword">protected</span> ValueCallback&lt;Uri[]&gt; mFileUploadCallbackSecond;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_FILE_PICKER = <span class="number">51426</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String mUploadableFileTypes = <span class="string">"image/*"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WebView mWebView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        initWebView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWebView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mWebView = (WebView) findViewById(R.id.my_webview);</span><br><span class="line"></span><br><span class="line">        mWebView.loadUrl(<span class="string">"file:///android_asset/index.html"</span>);</span><br><span class="line">        mWebView.setWebChromeClient(<span class="keyword">new</span> OpenFileChromeClient());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenFileChromeClient</span> <span class="keyword">extends</span> <span class="title">WebChromeClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  Android 2.2 (API level 8)到Android 2.3 (API level 10)版本选择文件时会触发该隐藏方法</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openFileChooser</span><span class="params">(ValueCallback&lt;Uri&gt; uploadMsg)</span> </span>&#123;</span><br><span class="line">            openFileChooser(uploadMsg, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Android 3.0 (API level 11)到 Android 4.0 (API level 15))版本选择文件时会触发，该方法为隐藏方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openFileChooser</span><span class="params">(ValueCallback&lt;Uri&gt; uploadMsg, String acceptType)</span> </span>&#123;</span><br><span class="line">            openFileChooser(uploadMsg, acceptType, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Android 4.1 (API level 16) -- Android 4.3 (API level 18)版本选择文件时会触发，该方法为隐藏方法</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openFileChooser</span><span class="params">(ValueCallback&lt;Uri&gt; uploadMsg, String acceptType, String capture)</span> </span>&#123;</span><br><span class="line">            openFileInput(uploadMsg, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Android 5.0 (API level 21)以上版本会触发该方法，该方法为公开方法</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"all"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onShowFileChooser</span><span class="params">(WebView webView, ValueCallback&lt;Uri[]&gt; filePathCallback, WebChromeClient.FileChooserParams fileChooserParams)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">21</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> allowMultiple = fileChooserParams.getMode() == FileChooserParams.MODE_OPEN_MULTIPLE;<span class="comment">//是否支持多选</span></span><br><span class="line">                openFileInput(<span class="keyword">null</span>, filePathCallback, allowMultiple);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"NewApi"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">openFileInput</span><span class="params">(<span class="keyword">final</span> ValueCallback&lt;Uri&gt; fileUploadCallbackFirst, <span class="keyword">final</span> ValueCallback&lt;Uri[]&gt; fileUploadCallbackSecond, <span class="keyword">final</span> <span class="keyword">boolean</span> allowMultiple)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Android 5.0以下版本</span></span><br><span class="line">        <span class="keyword">if</span> (mFileUploadCallbackFirst != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mFileUploadCallbackFirst.onReceiveValue(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mFileUploadCallbackFirst = fileUploadCallbackFirst;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Android 5.0及以上版本</span></span><br><span class="line">        <span class="keyword">if</span> (mFileUploadCallbackSecond != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mFileUploadCallbackSecond.onReceiveValue(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mFileUploadCallbackSecond = fileUploadCallbackSecond;</span><br><span class="line"></span><br><span class="line">        Intent i = <span class="keyword">new</span> Intent(Intent.ACTION_GET_CONTENT);</span><br><span class="line">        i.addCategory(Intent.CATEGORY_OPENABLE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allowMultiple) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">18</span>) &#123;</span><br><span class="line">                i.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        i.setType(mUploadableFileTypes);</span><br><span class="line"></span><br><span class="line">        startActivityForResult(Intent.createChooser(i, <span class="string">"选择文件"</span>), REQUEST_CODE_FILE_PICKER);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> <span class="keyword">int</span> resultCode, <span class="keyword">final</span> Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (requestCode == REQUEST_CODE_FILE_PICKER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resultCode == Activity.RESULT_OK) &#123;</span><br><span class="line">                <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//Android 5.0以下版本</span></span><br><span class="line">                    <span class="keyword">if</span> (mFileUploadCallbackFirst != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mFileUploadCallbackFirst.onReceiveValue(intent.getData());</span><br><span class="line">                        mFileUploadCallbackFirst = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (mFileUploadCallbackSecond != <span class="keyword">null</span>) &#123;<span class="comment">//Android 5.0及以上版本</span></span><br><span class="line">                        Uri[] dataUris = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (intent.getDataString() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                dataUris = <span class="keyword">new</span> Uri[] &#123; Uri.parse(intent.getDataString()) &#125;;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">16</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (intent.getClipData() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                        <span class="keyword">final</span> <span class="keyword">int</span> numSelectedFiles = intent.getClipData().getItemCount();</span><br><span class="line"></span><br><span class="line">                                        dataUris = <span class="keyword">new</span> Uri[numSelectedFiles];</span><br><span class="line"></span><br><span class="line">                                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSelectedFiles; i++) &#123;</span><br><span class="line">                                            dataUris[i] = intent.getClipData().getItemAt(i).getUri();</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (Exception ignored) &#123; &#125;</span><br><span class="line">                        mFileUploadCallbackSecond.onReceiveValue(dataUris);</span><br><span class="line">                        mFileUploadCallbackSecond = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//这里mFileUploadCallbackFirst跟mFileUploadCallbackSecond在不同系统版本下分别持有了</span></span><br><span class="line">                <span class="comment">//WebView对象，在用户取消文件选择器的情况下，需给onReceiveValue传null返回值</span></span><br><span class="line">                <span class="comment">//否则WebView在未收到返回值的情况下，无法进行任何操作，文件选择器会失效</span></span><br><span class="line">                <span class="keyword">if</span> (mFileUploadCallbackFirst != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mFileUploadCallbackFirst.onReceiveValue(<span class="keyword">null</span>);</span><br><span class="line">                    mFileUploadCallbackFirst = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (mFileUploadCallbackSecond != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mFileUploadCallbackSecond.onReceiveValue(<span class="keyword">null</span>);</span><br><span class="line">                    mFileUploadCallbackSecond = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="怎么为-WebView-的加载添加进度条"><a href="#怎么为-WebView-的加载添加进度条" class="headerlink" title="怎么为 WebView 的加载添加进度条"></a>怎么为 WebView 的加载添加进度条</h3><p>这里的 <code>onPageFinished()</code> 有个问题，不能在这里监听页面是否加载完毕（我自己测试的时候，好像在重定向和加载完 iframes 时都会调用这个方法）。<br>把页面加载完毕的判断放在 <code>onProgressChanged()</code> 里可能会更为准确。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebChromeClient(<span class="keyword">new</span> WebChromeClient() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProgressChanged</span><span class="params">(WebView view, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        progressBar.setProgress(position);</span><br><span class="line">        <span class="keyword">if</span> (position == <span class="number">100</span>) &#123;</span><br><span class="line">            progressBar.setVisibility(View.GONE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onProgressChanged(view, position);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">webView.setWebViewClient(<span class="keyword">new</span> WebViewClient()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageStarted</span><span class="params">(WebView view, String url, Bitmap favicon)</span> </span>&#123;</span><br><span class="line">        progressBar.setVisibility(View.VISIBLE);</span><br><span class="line">        <span class="keyword">super</span>.onPageStarted(view, url, favicon);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="怎样对页面进行-Js-注入？"><a href="#怎样对页面进行-Js-注入？" class="headerlink" title="怎样对页面进行 Js 注入？"></a>怎样对页面进行 Js 注入？</h3><p>首先你要在 WebView 开启 JavaScript,然后搭建桥梁<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">WebSettings webSettings = webView.getSettings();</span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> WebAppBridge(<span class="keyword">new</span> WebAppBridge.OauthLoginImpl() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getResult</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//TODO</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="string">"oauth"</span>);</span><br><span class="line">webView.loadUrl(<span class="string">"javascript:"</span> + getAssetsJs(<span class="string">"autologin.js"</span>));</span><br><span class="line">webView.loadUrl(<span class="string">"javascript:adduplistener()"</span>);</span><br></pre></td></tr></table></figure></p>
<p>WebAppBridge的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebAppBridge</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OauthLoginImpl oauthLogin;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebAppBridge</span><span class="params">(OauthLoginImpl oauthLogin)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.oauthLogin = oauthLogin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getResult</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (oauthLogin != <span class="keyword">null</span>)</span><br><span class="line">            oauthLogin.getResult(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OauthLoginImpl</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getResult</span><span class="params">(String s)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简单的说就是向网页注入一段 js, 在这段 js 里面设置回调到java中的方法 <code>getResult()</code>，由 WebAppBridge.getResult 来回收。<br>其中js的核心代码为<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oauth.getResult(str);</span><br></pre></td></tr></table></figure></p>
<p>其中 oauth 这个名称要与 <code>webView.addJavascriptInterface()</code>方法的第二个参数一样。</p>
<p>具体的代码可以参考这个项目中写的 js 注入逻辑 <a href="https://github.com/cpacm/MoeMusic/blob/master/app/src/main/java/com/cpacm/moemusic/ui/widgets/dialogs/OauthDialog.java" target="_blank" rel="noopener">OauthDialog</a></p>
<h3 id="如何手动添加-Cookie"><a href="#如何手动添加-Cookie" class="headerlink" title="如何手动添加 Cookie"></a>如何手动添加 Cookie</h3><p>需要获得 CookieManager 的对象并将 cookie 设置进去。<br><strong>从服务器的返回头中取出 cookie 根据Http请求的客户端不同，获取 cookie 的方式也不同，请自行获取。</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将cookie设置到 WebView</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url 要加载的 url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cookie 要同步的 cookie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">syncCookie</span><span class="params">(String url,String cookie)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">        CookieSyncManager.createInstance(context);</span><br><span class="line">    &#125;</span><br><span class="line">    CookieManager cookieManager = CookieManager.getInstance();</span><br><span class="line">    cookieManager.setAcceptCookie(<span class="keyword">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cookie 设置形式</span></span><br><span class="line"><span class="comment">     * cookieManager.setCookie(url, "key=value;" + "domain=[your domain];path=/;")</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    cookieManager.setCookie(url, cookie);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>删除 Cookie 的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个两个在 API level 21 被抛弃</span></span><br><span class="line"><span class="comment"> * CookieManager.getInstance().removeSessionCookie();</span></span><br><span class="line"><span class="comment"> * CookieManager.getInstance().removeAllCookie();</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 推荐使用这两个， level 21 新加的</span></span><br><span class="line"><span class="comment"> * CookieManager.getInstance().removeSessionCookies();</span></span><br><span class="line"><span class="comment"> * CookieManager.getInstance().removeAllCookies();</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeCookies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CookieManager cookieManager = CookieManager.getInstance();</span><br><span class="line">    cookieManager.removeAllCookie();</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">        cookieManager.flush();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CookieSyncManager.createInstance(Application.getInstance());</span><br><span class="line">        CookieSyncManager.getInstance().sync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="如何使-HTML5-video-在-WebView-全屏显示"><a href="#如何使-HTML5-video-在-WebView-全屏显示" class="headerlink" title="如何使 HTML5 video 在 WebView 全屏显示"></a>如何使 HTML5 video 在 WebView 全屏显示</h3><p>当网页全屏播放视频时会调用 <code>WebChromeClient.onShowCustomView()</code> 方法，所以可以通过将 video 播放的视图全屏达到目的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShowCustomView</span><span class="params">(View view, CustomViewCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (view <span class="keyword">instanceof</span> FrameLayout &amp;&amp; fullScreenView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// A video wants to be shown</span></span><br><span class="line">        <span class="keyword">this</span>.videoViewContainer = (FrameLayout) view;</span><br><span class="line">        <span class="keyword">this</span>.videoViewCallback = callback;</span><br><span class="line">        fullScreenView.addView(videoViewContainer, <span class="keyword">new</span> ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));</span><br><span class="line">        fullScreenView.setVisibility(View.VISIBLE);</span><br><span class="line">        isVideoFullscreen = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onHideCustomView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isVideoFullscreen &amp;&amp; fullScreenView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Hide the video view, remove it, and show the non-video view</span></span><br><span class="line">        fullScreenView.setVisibility(View.INVISIBLE);</span><br><span class="line">        fullScreenView.removeView(videoViewContainer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call back (only in API level &lt;19, because in API level 19+ with chromium webview it crashes)</span></span><br><span class="line">        <span class="keyword">if</span> (videoViewCallback != <span class="keyword">null</span> &amp;&amp; !videoViewCallback.getClass().getName().contains(<span class="string">".chromium."</span>)) &#123;</span><br><span class="line">            videoViewCallback.onCustomViewHidden();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        isVideoFullscreen = <span class="keyword">false</span>;</span><br><span class="line">        videoViewContainer = <span class="keyword">null</span>;</span><br><span class="line">        videoViewCallback = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是很多的手机版本在网页视频播放时是不会调用这个方法的，所以这个方法局限性很大。</p>
<h3 id="Android5-0上-WebView中Http和Https混合问题"><a href="#Android5-0上-WebView中Http和Https混合问题" class="headerlink" title="Android5.0上 WebView中Http和Https混合问题"></a>Android5.0上 WebView中Http和Https混合问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MIXED_CONTENT_ALWAYS_ALLOW：允许从任何来源加载内容，即使起源是不安全的；</span></span><br><span class="line"><span class="comment"> * MIXED_CONTENT_NEVER_ALLOW：不允许Https加载Http的内容，即不允许从安全的起源去加载一个不安全的资源；</span></span><br><span class="line"><span class="comment"> * MIXED_CONTENT_COMPATIBILITY_MODE：当涉及到混合式内容时，WebView 会尝试去兼容最新Web浏览器的风格。</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">     webView.getSettings().setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="如何避免-WebView-的内存泄露问题"><a href="#如何避免-WebView-的内存泄露问题" class="headerlink" title="如何避免 WebView 的内存泄露问题"></a>如何避免 WebView 的内存泄露问题</h3><ol>
<li>可以将 Webview 的 Activity 新起一个进程，结束的时候直接System.exit(0);退出当前进程；</li>
<li>不在xml中定义 WebView，而是在代码中创建，使用 getApplicationgContext() 作为传递的 Conetext；</li>
<li>在 Activity 销毁的时候，将 WebView 置空<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (webView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        webView.loadDataWithBaseURL(<span class="keyword">null</span>, <span class="string">""</span>, <span class="string">"text/html"</span>, <span class="string">"utf-8"</span>, <span class="keyword">null</span>);</span><br><span class="line">        webView.clearHistory();</span><br><span class="line">        ((ViewGroup) webView.getParent()).removeView(webView);</span><br><span class="line">        webView.destroy();</span><br><span class="line">        webView = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果你踩到了 WebView 上的坑，请先默哀一分钟，然后努力找找解决方法吧，总会有人体验过你的悲剧，也会有人重蹈你的覆辙。<br>当然 WebView 里肯定不止我上面列出来的这些问题，如果你有更多的 WebView 问题解决方案欢迎评论交流。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:348515494@qq.com">cpacm</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.cpacm.net/2017/02/10/Android开发日记（十四）——带你解决 WebView 里的常见问题/">http://www.cpacm.net/2017/02/10/Android开发日记（十四）——带你解决 WebView 里的常见问题/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.cpacm.net">cpacm</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android    </a><a class="post-meta__tags" href="/tags/开发系列/">开发系列    </a></div><div class="post_share"><div class="social-share" data-image="/img/android.jpg" data-sites="facebook,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2017/02/19/Android开发日记（十五）——音乐播放器要点/"><img class="prev_cover lozad" data-src="/img/android.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Android开发日记（十五）—— 音乐播放器要点</span></div></a></div><div class="next-post pull-right"><a href="/2017/02/10/MySQL基础知识/"><img class="next_cover lozad" data-src="https://cpacmblog.oss-cn-hangzhou.aliyuncs.com/mysql.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>MySQL基础知识</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/08/10/试试 Flutter/" title="Android开发日记（二十二）—— Flutter 的第一次尝试"><img class="relatedPosts_cover lozad" data-src="https://cpacmblog.oss-cn-hangzhou.aliyuncs.com/fluuter.jpg"><div class="relatedPosts_title">Android开发日记（二十二）—— Flutter 的第一次尝试</div></a></div><div class="relatedPosts_item"><a href="/2018/07/17/嵌入 ViewPager 的视频播放器/" title="Android开发日记（二十一）—— 嵌入 ViewPager 的视频播放器"><img class="relatedPosts_cover lozad" data-src="https://cpacmblog.oss-cn-hangzhou.aliyuncs.com/viewpager_video.jpg"><div class="relatedPosts_title">Android开发日记（二十一）—— 嵌入 ViewPager 的视频播放器</div></a></div><div class="relatedPosts_item"><a href="/2018/02/07/Android开发日记（二十）——Android 上的调色板 Palette/" title="Android开发日记（二十）—— Android 上的调色板 Palette"><img class="relatedPosts_cover lozad" data-src="https://cpacmblog.oss-cn-hangzhou.aliyuncs.com/vbox.webp"><div class="relatedPosts_title">Android开发日记（二十）—— Android 上的调色板 Palette</div></a></div><div class="relatedPosts_item"><a href="/2017/04/26/Android开发日记（十九）——说说 Android 里的 Handler 的机制/" title="Android开发日记（十九）——说说 Android 里的 Handler 的机制"><img class="relatedPosts_cover lozad" data-src="https://cpacmblog.oss-cn-hangzhou.aliyuncs.com/intent.jpg"><div class="relatedPosts_title">Android开发日记（十九）——说说 Android 里的 Handler 的机制</div></a></div><div class="relatedPosts_item"><a href="/2017/03/22/Android开发日记（十八）——规范你的 Android 项目/" title="Android开发日记（十八）—— Android 项目规范"><img class="relatedPosts_cover lozad" data-src="https://cpacmblog.oss-cn-hangzhou.aliyuncs.com/android.jpg"><div class="relatedPosts_title">Android开发日记（十八）—— Android 项目规范</div></a></div><div class="relatedPosts_item"><a href="/2017/03/09/Android开发日记（十七）——CoordinatorLayout 上的一些布局技巧/" title="Android开发日记（十七）—— CoordinatorLayout 上的一些布局技巧"><img class="relatedPosts_cover lozad" data-src="https://cpacmblog.oss-cn-hangzhou.aliyuncs.com/tablayout.webp"><div class="relatedPosts_title">Android开发日记（十七）—— CoordinatorLayout 上的一些布局技巧</div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://www.cpacm.net/2017/02/10/Android开发日记（十四）——带你解决 WebView 里的常见问题/';
  this.page.identifier = '2017/02/10/Android开发日记（十四）——带你解决 WebView 里的常见问题/';
  this.page.title = 'Android开发日记（十四）——带你解决 WebView 里的常见问题';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'cpacm-net' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By cpacm</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">簡</a><i class="fa fa-moon-o nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/local-search.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>